name: build

on: [push]

jobs:

  build:
    name: Build GitHubActionsDataCollector
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Output dotnet info
        run: dotnet --info

      - name: Restore GitHubActionsDataCollector.sln
        run: |
          dotnet restore ./GitHubActionsDataCollector.sln --verbosity m

      - name: Build GitHubActionsDataCollector.sln
        run: |
          dotnet build ./GitHubActionsDataCollector.sln --configuration Release --no-restore


  test:
    name: Test GitHubActionsDataCollector
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Output dotnet info
        run: dotnet --info

      - name: Restore GitHubActionsDataCollector.UnitTests
        run: |
          dotnet restore ./GitHubActionsDataCollector.UnitTests/GitHubActionsDataCollector.UnitTests.csproj --verbosity m

      - name: Build GitHubActionsDataCollector.UnitTests
        run: |
          dotnet build ./GitHubActionsDataCollector.UnitTests/GitHubActionsDataCollector.UnitTests.csproj --configuration Release --no-restore

      - name: Get failed tests
        uses: jameschristou/actions-get-failed-tests-from-artifacts@aaf8bc7de9163bd70f99e5c1d6e84b41c33ca336
        id: get_failed_tests
        with:
            name_of_the_test_run: "Test GitHubActionsDataCollector"

      - name: Update test filter
        run: |
            echo "Fail list: ${{steps.get_failed_tests.outputs.failed_tests}}"
            fail_list=${{steps.get_failed_tests.outputs.failed_tests}}
            echo "Fail list2: ${fail_list}"
            
            tests_filter = "Category!=Manual" # default filter
            
            tests_filter="${tests_filter%, }."  # Remove the trailing comma and space
            echo "tests_filter=$tests_filter" >> $GITHUB_OUTPUT
        shell: bash

      - name: Test GitHubActionsDataCollector.UnitTests
        run: |
          dotnet test ./GitHubActionsDataCollector.UnitTests/GitHubActionsDataCollector.UnitTests.csproj --configuration Release --no-restore --no-build --filter "Category!=Manual" --verbosity normal '-l:trx;LogFileName=testresults-attempt-${{github.run_attempt}}.xml'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
            name: Test Results for Attempt-${{github.run_attempt}}
            path: ./GitHubActionsDataCollector.UnitTests/TestResults/testresults-attempt-${{github.run_attempt}}.xml

      - name: Get failed tests
        uses: jameschristou/actions-get-failed-tests-from-artifacts@aaf8bc7de9163bd70f99e5c1d6e84b41c33ca336
        with:
            name_of_the_test_run: "Test GitHubActionsDataCollector"
